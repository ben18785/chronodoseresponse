---
title: "simulating_dose_response"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{simulating_dose_response}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This vignette describes how to simulate dose-response data as parameterised using estimates from Phillips et al. (2017). It also describes how types of experiment can be carried out on such data.


# Simulating data
Here, we simulate dose-response data for 41 individuals measured at four lux levels.
```{r setup}
library(chronodoseresponse)
library(dplyr)
library(purrr)

# generate data
lux <- c(1, 10, 100, 1000)
n <- 41
experimental_data <- virtual_experiment(n=n, lux=lux)

# look at it
glimpse(experimental_data)
```

The package also contains methods for visualising such data
```{r}
plot_doseresponse(experimental_data)
```

The estimates from Phillips et al. (2017) exhibited substantial inter-individual variability in individuals' response to light. Built into the package, we allow this individual variation to be reduced.
```{r}
experimental_data <- virtual_experiment(n=n, lux=lux,
                                        individual_variation_reduction=0.05)
plot_doseresponse(experimental_data)
```

# Experiments based on virtual population of individuals
The package also contains functionality for performing specific experiments based on a simulated population
of dose-response type data.

## Within-subject
Here, we first illustrate a within-subject experiment, in which the melatonin values for individuals measured at two
lux levels are compared using a paired t-test. Success of these experiments indicate that the difference in melatonin suppression between the two lux levels is of the correct sign and statistically significant (by default at the 5% level).
```{r}
# first generate large (ideally bigger than this if repeating experiments) virtual population of data
population_df <- virtual_experiment(n=200)

# compare melatonin suppression values at two lux levels using t test for a sample of 5 individuals
# repeat experiment 30 times at calculate fraction of successful results
lux_1 <- 10
lux_2 <- 30
nindiv <- 5
nreps <- 30
is_between <- F
results <- map_dbl(1:nreps, ~comparison_experiment(is_between, lux_1, lux_2, nindiv, population_df))
mean(results)
```

If we increase the sample size the fraction of successes should increase.
```{r}
nindiv <- 20
results <- map_dbl(1:nreps, ~comparison_experiment(is_between, lux_1, lux_2, nindiv, population_df))
mean(results)
```

Similarly if we make the two luxes more separated, the fraction of successes increases.
```{r}
nindiv <- 5
lux_2 <- 100
results <- map_dbl(1:nreps, ~comparison_experiment(is_between, lux_1, lux_2, nindiv, population_df))
mean(results)
```

## Between-subject
We now illustrate a between-subject experiment, in which two separate samples of individuals have their suppressions
measured at two different lux levels. Because of individual variation in dose-response curves, these experiments
tend to be less powerful thatn within-subject experiments.
```{r}
lux_1 <- 10
lux_2 <- 30
nindiv <- 20
nreps <- 30
results_b <- map_dbl(1:nreps, ~comparison_experiment(TRUE, lux_1, lux_2, nindiv, population_df))
mean(results_b)

results_w <- map_dbl(1:nreps, ~comparison_experiment(FALSE, lux_1, lux_2, nindiv, population_df))
mean(results_w)
```

